import React, { useState, useEffect } from 'react';
import { DollarSign, Home, ShoppingCart, Car, Film, Zap, PiggyBank, Package, AlertTriangle, CheckCircle, TrendingUp } from 'lucide-react';

export default function MoneyWise() {
  const [step, setStep] = useState('welcome');
  const [monthlyIncome, setMonthlyIncome] = useState('');
  const [expenses, setExpenses] = useState({
    rent: 0,
    food: 0,
    transport: 0,
    entertainment: 0,
    utilities: 0,
    savings: 0,
    others: 0
  });
  const [budgetData, setBudgetData] = useState(null);

  // Load saved data on mount
  useEffect(() => {
    loadBudget();
  }, []);

  const loadBudget = async () => {
    try {
      const result = await window.storage.get('moneywise-budget');
      if (result && result.value) {
        const data = JSON.parse(result.value);
        setMonthlyIncome(data.monthlyIncome || '');
        setExpenses(data.expenses || {
          rent: 0,
          food: 0,
          transport: 0,
          entertainment: 0,
          utilities: 0,
          savings: 0,
          others: 0
        });
        if (data.budgetData) {
          setBudgetData(data.budgetData);
          setStep('results');
        }
      }
    } catch (error) {
      console.log('No saved budget found');
    }
  };

  const saveBudget = async (income, exp, budget) => {
    try {
      await window.storage.set('moneywise-budget', JSON.stringify({
        monthlyIncome: income,
        expenses: exp,
        budgetData: budget
      }));
    } catch (error) {
      console.error('Failed to save budget:', error);
    }
  };

  const handleIncomeSubmit = () => {
    const income = parseFloat(monthlyIncome);
    if (income > 0) {
      setStep('categories');
    } else {
      alert('Please enter a valid income greater than $0');
    }
  };

  const handleExpenseUpdate = (category, value) => {
    setExpenses(prev => ({
      ...prev,
      [category]: parseFloat(value) || 0
    }));
  };

  const calculateBudget = () => {
    const income = parseFloat(monthlyIncome);
    const totalExpenses = Object.values(expenses).reduce((sum, val) => sum + val, 0);
    const remaining = income - totalExpenses;

    const percentages = {};
    Object.keys(expenses).forEach(key => {
      percentages[`${key}_percentage`] = ((expenses[key] / income) * 100).toFixed(1);
    });

    // Find highest expense
    let highestCategory = 'rent';
    let highestAmount = expenses.rent;
    Object.entries(expenses).forEach(([key, value]) => {
      if (value > highestAmount) {
        highestAmount = value;
        highestCategory = key;
      }
    });

    // Calculate financial health score
    let score = 100;
    if (remaining < 0) score -= 30;
    if (percentages.rent_percentage > 40) score -= 15;
    if (percentages.savings_percentage < 10) score -= 20;

    let status = 'Healthy';
    if (score >= 80) status = 'Excellent';
    else if (score >= 50) status = 'Warning';
    else status = 'Critical';

    const budget = {
      income,
      totalExpenses,
      remaining,
      percentages,
      highestCategory,
      highestAmount,
      score,
      status,
      expenses
    };

    setBudgetData(budget);
    saveBudget(monthlyIncome, expenses, budget);
    setStep('results');
  };

  const resetBudget = async () => {
    try {
      await window.storage.delete('moneywise-budget');
    } catch (error) {
      console.log('Error clearing budget');
    }
    setMonthlyIncome('');
    setExpenses({
      rent: 0,
      food: 0,
      transport: 0,
      entertainment: 0,
      utilities: 0,
      savings: 0,
      others: 0
    });
    setBudgetData(null);
    setStep('welcome');
  };

  const categoryIcons = {
    rent: Home,
    food: ShoppingCart,
    transport: Car,
    entertainment: Film,
    utilities: Zap,
    savings: PiggyBank,
    others: Package
  };

  const categoryLabels = {
    rent: 'Rent/Mortgage',
    food: 'Food & Groceries',
    transport: 'Transportation',
    entertainment: 'Entertainment',
    utilities: 'Utilities/Bills',
    savings: 'Savings',
    others: 'Other Expenses'
  };

  if (step === 'welcome') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-emerald-50 to-teal-100 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
          <div className="bg-emerald-500 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
            <DollarSign className="text-white" size={40} />
          </div>
          <h1 className="text-4xl font-bold text-gray-800 mb-4">MoneyWise üí∞</h1>
          <p className="text-gray-600 mb-8">Your personal budget assistant is here to help you take control of your finances. Let's build a budget that works for YOU! üìä</p>
          <button 
            onClick={() => setStep('income')}
            className="bg-emerald-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-emerald-600 transition-colors w-full"
          >
            Get Started
          </button>
        </div>
      </div>
    );
  }

  if (step === 'income') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-emerald-50 to-teal-100 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
          <h2 className="text-3xl font-bold text-gray-800 mb-6">Monthly Income</h2>
          <p className="text-gray-600 mb-6">First, let's start with your monthly income. What is your total monthly income?</p>
          <div className="relative mb-6">
            <span className="absolute left-4 top-3 text-gray-500 text-xl">$</span>
            <input 
              type="number"
              value={monthlyIncome}
              onChange={(e) => setMonthlyIncome(e.target.value)}
              placeholder="Enter amount"
              className="w-full pl-10 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:border-emerald-500 focus:outline-none text-lg"
            />
          </div>
          <button 
            onClick={handleIncomeSubmit}
            className="bg-emerald-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-emerald-600 transition-colors w-full"
          >
            Continue
          </button>
        </div>
      </div>
    );
  }

  if (step === 'categories') {
    const income = parseFloat(monthlyIncome);
    const totalExpenses = Object.values(expenses).reduce((sum, val) => sum + val, 0);
    const remaining = income - totalExpenses;

    return (
      <div className="min-h-screen bg-gradient-to-br from-emerald-50 to-teal-100 p-4 py-8">
        <div className="max-w-4xl mx-auto">
          <div className="bg-white rounded-2xl shadow-2xl p-6 mb-6">
            <h2 className="text-3xl font-bold text-gray-800 mb-4">Budget Tracker üìä</h2>
            <div className="grid grid-cols-3 gap-4 mb-6">
              <div className="text-center">
                <p className="text-gray-600 text-sm">Monthly Income</p>
                <p className="text-2xl font-bold text-emerald-600">${income.toFixed(2)}</p>
              </div>
              <div className="text-center">
                <p className="text-gray-600 text-sm">Total Expenses</p>
                <p className="text-2xl font-bold text-orange-600">${totalExpenses.toFixed(2)}</p>
              </div>
              <div className="text-center">
                <p className="text-gray-600 text-sm">Remaining</p>
                <p className={`text-2xl font-bold ${remaining >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                  ${remaining.toFixed(2)}
                </p>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-2xl shadow-2xl p-6">
            <h3 className="text-2xl font-bold text-gray-800 mb-6">Add Your Expenses</h3>
            <div className="grid md:grid-cols-2 gap-4 mb-6">
              {Object.entries(categoryLabels).map(([key, label]) => {
                const Icon = categoryIcons[key];
                return (
                  <div key={key} className="border-2 border-gray-200 rounded-lg p-4 hover:border-emerald-500 transition-colors">
                    <div className="flex items-center mb-2">
                      <Icon className="text-emerald-600 mr-2" size={24} />
                      <label className="font-semibold text-gray-700">{label}</label>
                    </div>
                    <div className="relative">
                      <span className="absolute left-3 top-2 text-gray-500">$</span>
                      <input 
                        type="number"
                        value={expenses[key] || ''}
                        onChange={(e) => handleExpenseUpdate(key, e.target.value)}
                        placeholder="0.00"
                        className="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:border-emerald-500 focus:outline-none"
                      />
                    </div>
                  </div>
                );
              })}
            </div>
            <button 
              onClick={calculateBudget}
              className="bg-emerald-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-emerald-600 transition-colors w-full text-lg"
            >
              ‚úÖ Calculate My Budget
            </button>
          </div>
        </div>
      </div>
    );
  }

  if (step === 'results' && budgetData) {
    const { income, totalExpenses, remaining, percentages, highestCategory, highestAmount, score, status } = budgetData;

    return (
      <div className="min-h-screen bg-gradient-to-br from-emerald-50 to-teal-100 p-4 py-8">
        <div className="max-w-4xl mx-auto">
          <div className="bg-white rounded-2xl shadow-2xl p-8 mb-6">
            <h2 className="text-4xl font-bold text-gray-800 mb-6 text-center">üí∞ MoneyWise Budget Report</h2>
            
            {/* Financial Health Score */}
            <div className={`rounded-xl p-6 mb-6 ${
              status === 'Excellent' ? 'bg-green-100 border-2 border-green-500' :
              status === 'Warning' ? 'bg-yellow-100 border-2 border-yellow-500' :
              'bg-red-100 border-2 border-red-500'
            }`}>
              <div className="flex items-center justify-between mb-2">
                <h3 className="text-xl font-bold text-gray-800">Financial Health Score</h3>
                {status === 'Excellent' && <CheckCircle className="text-green-600" size={32} />}
                {status === 'Warning' && <AlertTriangle className="text-yellow-600" size={32} />}
                {status === 'Critical' && <AlertTriangle className="text-red-600" size={32} />}
              </div>
              <p className="text-5xl font-bold mb-2">{score}/100</p>
              <p className={`font-semibold text-lg ${
                status === 'Excellent' ? 'text-green-700' :
                status === 'Warning' ? 'text-yellow-700' :
                'text-red-700'
              }`}>
                Status: {status === 'Excellent' ? '‚úÖ EXCELLENT' : status === 'Warning' ? '‚ö†Ô∏è NEEDS ATTENTION' : 'üö® CRITICAL'}
              </p>
            </div>

            {/* Overview */}
            <div className="grid md:grid-cols-3 gap-4 mb-6">
              <div className="bg-emerald-50 rounded-lg p-4 border-2 border-emerald-200">
                <p className="text-gray-600 text-sm mb-1">Monthly Income</p>
                <p className="text-3xl font-bold text-emerald-600">${income.toFixed(2)}</p>
              </div>
              <div className="bg-orange-50 rounded-lg p-4 border-2 border-orange-200">
                <p className="text-gray-600 text-sm mb-1">Total Expenses</p>
                <p className="text-3xl font-bold text-orange-600">${totalExpenses.toFixed(2)}</p>
              </div>
              <div className={`rounded-lg p-4 border-2 ${remaining >= 0 ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                <p className="text-gray-600 text-sm mb-1">Remaining</p>
                <p className={`text-3xl font-bold ${remaining >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                  ${remaining.toFixed(2)}
                </p>
              </div>
            </div>

            {/* Overspending Alert */}
            {remaining < 0 && (
              <div className="bg-red-100 border-2 border-red-500 rounded-lg p-4 mb-6">
                <h4 className="font-bold text-red-700 text-lg mb-2">üö® WARNING: OVERSPENDING DETECTED!</h4>
                <p className="text-red-700">You're spending <strong>${Math.abs(remaining).toFixed(2)}</strong> MORE than your income! This is not sustainable.</p>
              </div>
            )}

            {/* Expense Breakdown */}
            <h3 className="text-2xl font-bold text-gray-800 mb-4">üìà Expense Breakdown</h3>
            <div className="space-y-3 mb-6">
              {Object.entries(budgetData.expenses).map(([key, value]) => {
                const Icon = categoryIcons[key];
                const percentage = parseFloat(percentages[`${key}_percentage`]);
                const isHigh = (key === 'rent' && percentage >= 30) || 
                              (key === 'food' && percentage >= 25) ||
                              (key === 'transport' && percentage >= 20) ||
                              (key === 'entertainment' && percentage >= 15);
                
                return (
                  <div key={key} className={`border-2 rounded-lg p-4 ${isHigh ? 'border-yellow-400 bg-yellow-50' : 'border-gray-200'}`}>
                    <div className="flex items-center justify-between mb-2">
                      <div className="flex items-center">
                        <Icon className="text-emerald-600 mr-2" size={24} />
                        <span className="font-semibold text-gray-700">{categoryLabels[key]}</span>
                      </div>
                      <div className="text-right">
                        <p className="font-bold text-lg">${value.toFixed(2)}</p>
                        <p className="text-sm text-gray-600">{percentage.toFixed(1)}%</p>
                      </div>
                    </div>
                    <div className="w-full bg-gray-200 rounded-full h-2">
                      <div 
                        className={`h-2 rounded-full ${isHigh ? 'bg-yellow-500' : 'bg-emerald-500'}`}
                        style={{ width: `${Math.min(percentage, 100)}%` }}
                      ></div>
                    </div>
                    {isHigh && (
                      <p className="text-yellow-700 text-sm mt-2">
                        ‚ö†Ô∏è This category is higher than recommended
                      </p>
                    )}
                  </div>
                );
              })}
            </div>

            {/* Highest Expense */}
            <div className="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mb-6">
              <div className="flex items-center mb-2">
                <TrendingUp className="text-blue-600 mr-2" size={24} />
                <h4 className="font-bold text-blue-900 text-lg">Spending Analysis</h4>
              </div>
              <p className="text-blue-800">Your highest expense category is <strong>{categoryLabels[highestCategory]}</strong></p>
              <p className="text-blue-800">Amount: <strong>${highestAmount.toFixed(2)}</strong> ({percentages[`${highestCategory}_percentage`]}%)</p>
              <p className="text-blue-700 text-sm mt-2">This is your biggest opportunity for savings!</p>
            </div>

            {/* Recommendations */}
            <div className={`rounded-lg p-6 mb-6 ${
              status === 'Excellent' ? 'bg-green-50 border-2 border-green-300' :
              status === 'Warning' ? 'bg-yellow-50 border-2 border-yellow-300' :
              'bg-red-50 border-2 border-red-300'
            }`}>
              <h4 className="font-bold text-lg mb-3">
                {status === 'Excellent' ? '‚úÖ Keep Up The Great Work!' :
                 status === 'Warning' ? '‚ö†Ô∏è Improvement Recommendations' :
                 'üö® Urgent Recommendations'}
              </h4>
              {status === 'Critical' && (
                <ul className="list-disc list-inside space-y-1 text-red-800">
                  <li>Review {categoryLabels[highestCategory]} spending immediately</li>
                  <li>Cut non-essential spending</li>
                  <li>Find ways to increase income</li>
                  <li>Consider financial counseling</li>
                  <li>Build an emergency fund ASAP</li>
                </ul>
              )}
              {status === 'Warning' && (
                <ul className="list-disc list-inside space-y-1 text-yellow-800">
                  <li>Reduce {categoryLabels[highestCategory]} expenses by 10-15%</li>
                  <li>Increase savings to at least 10-15% of income</li>
                  <li>Track daily expenses to find leaks</li>
                  <li>Set spending limits for discretionary categories</li>
                  <li>Review subscriptions and recurring charges</li>
                </ul>
              )}
              {status === 'Excellent' && (
                <ul className="list-disc list-inside space-y-1 text-green-800">
                  <li>Continue current budgeting habits</li>
                  <li>Consider increasing savings rate</li>
                  <li>Explore investment opportunities</li>
                  <li>Build 3-6 months emergency fund</li>
                  <li>Plan for long-term financial goals</li>
                </ul>
              )}
            </div>

            {/* Money Saving Tips */}
            <div className="bg-purple-50 border-2 border-purple-300 rounded-lg p-6 mb-6">
              <h4 className="font-bold text-purple-900 text-lg mb-3">üí° Money-Saving Tips</h4>
              <div className="space-y-2 text-sm text-purple-800">
                <p><strong>üè† Rent:</strong> Consider roommates, negotiate lease, move to cheaper area</p>
                <p><strong>üçî Food:</strong> Meal prep, use coupons, buy generic brands, shop sales</p>
                <p><strong>üöó Transport:</strong> Carpool, bike, public transit, maintain vehicle</p>
                <p><strong>üé¨ Entertainment:</strong> Free activities, libraries, community events</p>
                <p><strong>üí° Utilities:</strong> Energy-efficient appliances, unplug devices, conserve water</p>
                <p><strong>üí∞ Savings:</strong> Automate transfers, high-yield savings, 50/30/20 rule</p>
              </div>
              <p className="text-purple-700 font-semibold mt-3">Small changes add up to BIG savings over time!</p>
            </div>

            {/* Action Buttons */}
            <div className="grid md:grid-cols-2 gap-4">
              <button 
                onClick={() => setStep('categories')}
                className="bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors"
              >
                Adjust Budget
              </button>
              <button 
                onClick={resetBudget}
                className="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-colors"
              >
                Start New Budget
              </button>
            </div>
          </div>

          <div className="text-center text-gray-600">
            <p className="text-sm">A budget is telling your money where to go instead of wondering where it went! üí∞</p>
          </div>
        </div>
      </div>
    );
  }

  return null;
}